<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ркмрк╛рк│ркХ ркорк╛рк╣рк┐ркдрлА рк╡рлНркпрк╡рк╕рлНркерк╛рккрки рккрлНрк░ркгрк╛рк▓рлА</title>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  /* CSS Variables for Light Theme */
  :root {
    --bg: linear-gradient(135deg, #f8f9ff 0%, #e6f0ff 100%);
    --card: #ffffff;
    --primary: #6a11cb;
    --secondary: #2575fc;
    --accent: #ff6b6b;
    --muted: #6c757d;
    --success: #28a745;
    --warning: #ffc107;
    --danger: #dc3545;
    --info: #17a2b8;
    --light: #f8f9fa;
    --dark: #343a40;
    --radius: 12px;
    --shadow: 0 10px 30px rgba(0,0,0,0.1);
    --shadow-sm: 0 4px 6px rgba(0,0,0,0.07);
    --text-color: #333; /* Key for visibility */
    --header-bg: linear-gradient(90deg, #6a11cb, #2575fc);
    --form-bg: linear-gradient(to right, #ffffff, #f8f9ff);
    --border-color: #eaeef7;
    --table-header-bg: linear-gradient(to right, #f8f9ff, #eaeef7);
    --table-row-hover: #eaeef7;
    --table-row-even: #f8f9ff;
    --footer-bg: linear-gradient(to right, #f8f9ff, #eaeef7);
    --toggle-bg: #6a11cb;
    --toggle-circle: #ffffff;
    --checkbox-border: #ccc;
    --checkbox-checked: var(--primary);
    --input-bg: #ffffff; /* Input background */
  }

  /* CSS Variables for Dark Theme - FIXED COLORS */
  [data-theme="dark"] {
    --bg: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
    --card: #1e1e2e;
    --primary: #bb86fc;
    --secondary: #03dac6;
    --accent: #cf6679;
    --muted: #9ca3af;
    --success: #4caf50;
    --warning: #ff9800;
    --danger: #f44336;
    --info: #03a9f4;
    --light: #374151;
    --dark: #f9fafb;
    --radius: 12px;
    --shadow: 0 10px 30px rgba(0,0,0,0.3);
    --shadow-sm: 0 4px 6px rgba(0,0,0,0.2);
    --text-color: #e5e7eb; /* FIXED: Light text for dark background */
    --header-bg: linear-gradient(90deg, #bb86fc, #03dac6);
    --form-bg: linear-gradient(to right, #1e1e2e, #2d2d44);
    --border-color: #374151;
    --table-header-bg: linear-gradient(to right, #374151, #4b5563);
    --table-row-hover: #374151;
    --table-row-even: #2d3748;
    --footer-bg: linear-gradient(to right, #1e1e2e, #2d2d44);
    --toggle-bg: #bb86fc;
    --toggle-circle: #f9fafb;
    --checkbox-border: #555;
    --checkbox-checked: var(--primary);
    --input-bg: #2d2d44; /* FIXED: Darker input background for contrast */
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color:var(--text-color);
    line-height:1.6;
    padding:20px;
    transition: all 0.3s ease;
  }
  .container{
    max-width:1200px;
    margin:0 auto;
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:30px;
    animation: fadeIn 0.5s ease-in-out;
    transition: all 0.3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Theme Toggle and Close Button Container */
  .theme-toggle-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex; /* Use flexbox for alignment */
    align-items: center;
    gap: 15px; /* Space between buttons */
  }
  
  /* Close App Button */
  .btn-close-app {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(90deg, var(--danger), #a71e2a);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }

  .btn-close-app i {
    font-size: 18px;
  }

  .btn-close-app:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
  }
  
  .theme-toggle {
    position: relative;
    width: 70px;
    height: 34px;
    background: var(--toggle-bg);
    border-radius: 34px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  
  .theme-toggle-circle {
    position: absolute;
    top: 3px;
    left: 3px;
    width: 28px;
    height: 28px;
    background: var(--toggle-circle);
    border-radius: 50%;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .theme-toggle-circle i {
    font-size: 16px;
    color: var(--toggle-bg);
  }
  
  [data-theme="dark"] .theme-toggle-circle {
    transform: translateX(36px);
  }
  
  /* Dropdown for Age Group Filter */
  .custom-dropdown {
      position: relative;
      display: inline-block;
      min-width: 200px;
  }
  
  .dropdown-btn {
      padding: 10px 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg); /* Use input-bg for consistency */
      color: var(--text-color);
      text-align: left;
      cursor: pointer;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
  }
  .dropdown-btn:hover {
      border-color: var(--primary);
  }

  .dropdown-content {
      display: none;
      position: absolute;
      background-color: var(--card);
      min-width: 200px;
      box-shadow: var(--shadow);
      border-radius: 8px;
      z-index: 10;
      padding: 10px 0;
      margin-top: 4px;
      border: 1px solid var(--border-color);
  }
  .dropdown-content.show {
      display: block;
  }

  /* Checkbox styling inside dropdown */
  .checkbox-group label {
      display: flex;
      align-items: center;
      padding: 5px 15px;
      cursor: pointer;
      font-weight: normal;
      font-size: 14px;
      color: var(--text-color);
      transition: background-color 0.2s;
  }
  .checkbox-group label:hover {
      background-color: var(--table-row-hover);
  }
  .checkbox-group input[type="checkbox"] {
      margin-right: 8px;
      width: 16px;
      height: 16px;
      min-width: 16px;
      border: 1px solid var(--checkbox-border);
      border-radius: 4px;
      appearance: none;
      -webkit-appearance: none;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--input-bg); /* Use input-bg for checkbox */
  }
  .checkbox-group input[type="checkbox"]:checked {
      background-color: var(--checkbox-checked);
      border-color: var(--checkbox-checked);
  }
  .checkbox-group input[type="checkbox"]:checked::before {
      content: '\2713'; /* Checkmark Unicode */
      display: block;
      color: white;
      font-size: 12px;
      text-align: center;
      line-height: 14px;
  }
  
  h1{
    margin:0 0 20px;
    font-size:28px;
    color:var(--primary);
    text-align:center;
    position:relative;
    padding-bottom:15px;
  }
  h1:after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    border-radius: 3px;
  }
  /* Header with icon */
  .header-icon {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
  }
  .header-icon i {
    font-size: 48px;
    color: var(--primary);
    background: rgba(106, 17, 203, 0.1);
    padding: 15px;
    border-radius: 50%;
    transition: all 0.3s ease;
  }
  
  [data-theme="dark"] .header-icon i {
    background: rgba(187, 134, 252, 0.1);
  }
  
  /* Form styling */
  .form-card {
    background: var(--form-bg);
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }
  
  .form-title {
    font-size: 20px;
    color: var(--primary);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
  }
  .form-title i {
    margin-right: 10px;
  }
  /* Updated grid layout for new field */
  form{
    display:grid;
    grid-template-columns:1fr 1fr 1fr; /* 3 columns for better use of space */
    gap:15px;
  }
  @media(max-width:900px){form{grid-template-columns:1fr 1fr}} /* 2 columns on tablet */
  @media(max-width:550px){form{grid-template-columns:1fr}} /* 1 column on mobile */

  .form-group {
    display: flex;
    flex-direction: column;
  }
  label{
    font-size:14px;
    color:var(--text-color);
    margin-bottom:6px;
    font-weight:600;
    display: flex;
    align-items: center;
  }
  label i {
    margin-right: 5px;
    color: var(--primary);
  }
  input[type="text"], input[type="date"], input[type="tel"], input[type="number"], select{
    width:100%;
    padding:12px 15px;
    border:1px solid var(--border-color);
    border-radius:8px;
    background:var(--input-bg); /* Use variable for input background */
    font-size:14px;
    color:var(--text-color); /* Use variable for input text color */
    transition:all 0.3s ease;
  }
  
  input:focus, select:focus{
    outline:none;
    border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(106, 17, 203, 0.2);
  }
  
  .btn-primary{
    grid-column:1/-1;
    background:linear-gradient(90deg,var(--primary),var(--secondary));
    color:white;
    padding:12px 20px;
    border-radius:8px;
    border:none;
    font-weight:600;
    cursor:pointer;
    font-size:16px;
    transition:all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .btn-primary:hover{
    transform:translateY(-2px);
    box-shadow:0 5px 15px rgba(106, 17, 203, 0.3);
  }
  
  /* Filters section */
  .filters-card {
    background: var(--form-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }
  
  .filters-title {
    font-size: 18px;
    color: var(--primary);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
  }
  .filters-title i {
    margin-right: 10px;
  }
  .filters{
    display:flex;
    gap:15px;
    align-items:flex-start; 
    flex-wrap:wrap;
    justify-content:space-between;
  }
  
  .filter-options {
    display: flex;
    gap: 15px;
    align-items: flex-start;
  }

  .filters select{
    padding:10px 15px;
    border-radius:8px;
    border:1px solid var(--border-color);
    background:var(--input-bg); /* Use variable for select background */
    min-width:150px;
    color:var(--text-color); /* Use variable for select text color */
  }
  
  /* Custom Import/Export Buttons */
  .custom-action-buttons .btn {
      background: linear-gradient(90deg, #17a2b8, #0c7b93);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-right: 8px;
      display: inline-flex;
      align-items: center;
  }
  .custom-action-buttons .btn:last-child {
      background: linear-gradient(90deg, #ffc107, #e0a800);
      color: #333;
  }
  .custom-action-buttons .btn:last-child i {
      color: #333;
  }
  .custom-action-buttons .btn i {
      margin-right: 5px;
  }
  .custom-action-buttons .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
  }
  .custom-action-buttons .btn:last-child:hover {
      box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
  }
  /* Hiding the file input */
  #importFile {
      display: none;
  }
  
  /* Records per page selector */
  .records-selector {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
  }
  
  .records-selector label {
    margin: 0;
    font-size: 12px;
    color: var(--text-color);
    white-space: nowrap;
  }
  
  .records-selector select {
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid var(--border-color);
    background: var(--input-bg); /* Use variable for select background */
    color: var(--text-color);
    min-width: auto;
    font-size: 12px;
    width: 50px;
  }
  
  /* Table section */
  .table-card {
    background: var(--form-bg);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }
  
  .table-wrap{
    overflow:auto;
    background:var(--card);
    padding:15px;
    border-radius:8px;
    box-shadow:var(--shadow-sm);
  }
  table.dataTable{
    width:100% !important;
    border-collapse:collapse;
  }
  th,td{
    padding:12px 15px;
    border-bottom:1px solid var(--border-color);
    vertical-align:middle;
  }
  th{
    background:var(--table-header-bg);
    font-weight:600;
    color:var(--primary);
    position: sticky;
    top: 0;
  }
  tr:nth-child(even) td{
    background:var(--table-row-even);
  }
  tr:hover td {
    background: var(--table-row-hover);
  }
  /* Grade pills */
  .pill{
    display:inline-block;
    padding:6px 12px;
    border-radius:20px;
    color:white;
    font-weight:600;
    font-size:13px;
    white-space: nowrap;
  }
  .pill.ok{background:var(--success)}
  .pill.warn{background:var(--warning);color:#333}
  .pill.bad{background:var(--danger)}
  
  /* Dark Mode specific text color for warning pill text */
  [data-theme="dark"] .pill.warn {
      color: var(--dark); /* Ensure text is dark on yellow warning pill in dark mode */
  }

  /* Action buttons */
  .action-btn{
    border:none;
    padding:8px 12px;
    border-radius:6px;
    color:#fff;
    font-weight:600;
    cursor:pointer;
    margin-right:5px;
    margin-bottom: 5px;
    transition:all 0.3s ease;
    display: inline-flex;
    align-items: center;
  }
  .action-btn i {
    margin-right: 5px;
  }
  .edit{
    background:linear-gradient(90deg,var(--info),#0c7b93);
  }
  .del{
    background:linear-gradient(90deg,var(--danger),#a71e2a);
  }
  .dt-button{
    border-radius:8px;
    padding:8px 12px;
    margin-right:8px;
    background:linear-gradient(90deg,var(--primary),var(--secondary));
    border:none;
    color:#fff;
    font-weight:600;
    transition:all 0.3s ease;
  }

  /* Progress Indicators */
  .progress-indicator {
      font-size: 14px;
      font-weight: bold;
      margin-left: 5px;
      display: inline-block;
      white-space: nowrap;
  }
  .progress-indicator.increase { color: var(--success); }
  .progress-indicator.decrease { color: var(--danger); }
  .progress-indicator.same { color: var(--warning); }
  
  /* Responsive adjustments (Mobile-Friendly) */
  @media(max-width:768px){
    .container{padding:15px;}
    h1{font-size:24px;}
    .filters-card, .table-card { padding: 15px; }
    
    .filters {
        flex-direction: column;
        align-items: stretch;
    }
    .filter-options {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
    }
    /* Set minimum width for dropdown and select on mobile */
    .custom-dropdown, .filters select {
        min-width: 100%; 
        width: 100%;
    }
    .filters select {
        box-sizing: border-box; 
    }
    /* Fix dropdown content overflow on small screens */
    .dropdown-content {
        min-width: 90vw; /* Take up most of viewport width */
        right: 0; /* Align right on mobile */
        left: auto;
    }
    .dt-buttons {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        gap: 5px;
        margin-bottom: 10px;
    }
    .dt-button {
        width: calc(50% - 5px);
        margin-right: 0;
        margin-bottom: 5px;
        font-size: 11px;
        padding: 5px 6px;
    }
    .custom-action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }
    .custom-action-buttons .btn {
        flex-grow: 1; /* Allow buttons to expand */
        margin-right: 0;
        font-size: 12px;
    }
  }
  
  /* Success message */
  .success-message {
    background: var(--success);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
    align-items: center;
  }
  .error-message {
    background: var(--danger);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
    align-items: center;
  }
  .success-message i, .error-message i {
    margin-right: 10px;
  }
  
  /* Table Header Title/Records Selector Alignment */
  .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
  }
  .table-title {
      font-size: 18px;
      color: var(--primary);
      display: flex;
      align-items: center;
  }
  .table-title i {
      margin-right: 10px;
  }
  
  /* Footer Styling */
  footer {
    text-align: center;
    margin-top: 30px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
    font-size: 14px;
    color: var(--muted);
  }
  footer i {
    margin-right: 5px;
    color: var(--primary);
  }

  /* -------------------------
     PASSWORD OVERLAY STYLES
     ------------------------- */
  #passwordOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    transition: opacity 0.5s ease;
  }

  .login-container {
    background: var(--card);
    padding: 40px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    text-align: center;
    max-width: 400px;
    width: 90%;
  }

  .login-container h2 {
    color: var(--primary);
    margin-bottom: 20px;
  }

  .login-container p {
    color: var(--text-color);
    margin-bottom: 25px;
    font-size: 16px;
    line-height: 1.6;
  }

  #passwordInput {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg); /* Use variable for input background */
    font-size: 16px;
    color: var(--text-color); /* Use variable for input text color */
    margin-bottom: 20px;
    box-sizing: border-box;
  }

  #loginBtn {
    width: 100%;
    background: linear-gradient(90deg,var(--primary),var(--secondary));
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
  }

  #loginBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(106, 17, 203, 0.3);
  }

  #loginError {
    color: var(--danger);
    margin-top: 15px;
    font-weight: 600;
    display: none; /* Initially hidden */
  }

  /* Hide main app initially */
  #mainApp {
    display: none;
  }

  /* Date input styling for DD/MM/YYYY format */
  .date-input-wrapper {
    position: relative;
  }
  
  .date-display {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    color: var(--muted);
    background: var(--input-bg); /* Use variable for input background */
    padding: 2px 6px;
    border-radius: 4px;
    pointer-events: none;
  }

  /* Disclaimer Box Style */
  .disclaimer-box {
    background: var(--table-row-even);
    border: 1px solid var(--border-color);
    padding: 15px;
    border-radius: var(--radius);
    margin-top: 25px;
    margin-bottom: 20px;
    font-size: 14px;
    color: var(--text-color);
    box-shadow: var(--shadow-sm);
  }
  .disclaimer-box h3 {
    margin-top: 0;
    font-size: 16px;
    color: var(--danger);
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  .disclaimer-box h3 i {
    margin-right: 8px;
    color: var(--warning);
  }
  .disclaimer-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 13px;
  }
  .disclaimer-table th, .disclaimer-table td {
    border: 1px solid var(--border-color);
    padding: 8px;
    text-align: left;
  }
  .disclaimer-table th {
    background: var(--table-header-bg);
    color: var(--primary);
  }

  .measurement-history-btn {
      background: none;
      border: 1px solid var(--info);
      color: var(--info);
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 5px;
      display: inline-block;
      transition: all 0.2s;
  }
  .measurement-history-btn:hover {
      background: var(--info);
      color: white;
  }
  
  /* Modal Styles */
  .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
  }
  .modal-content {
      background-color: var(--card);
      margin: 15% auto;
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 80%;
      max-width: 600px;
      position: relative;
      animation: modalOpen 0.3s ease-in-out;
  }
  .modal-close {
      color: var(--danger);
      float: right;
      font-size: 28px;
      font-weight: bold;
      transition: all 0.2s;
  }
  .modal-close:hover, .modal-close:focus {
      color: var(--primary);
      text-decoration: none;
      cursor: pointer;
  }
  .modal-content h2 {
      color: var(--primary);
      margin-top: 0;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
      margin-bottom: 15px;
  }
  .modal-table {
      width: 100%;
      border-collapse: collapse;
  }
  .modal-table th, .modal-table td {
      border: 1px solid var(--border-color);
      padding: 10px;
      text-align: left;
  }
  .modal-table th {
      background: var(--table-header-bg);
      color: var(--primary);
      font-size: 14px;
  }
  .modal-table td {
      font-size: 14px;
  }
  @keyframes modalOpen {
      from { opacity: 0; transform: translateY(-50px); }
      to { opacity: 1; transform: translateY(0); }
  }
  
</style>
</head>
<body>

<div id="passwordOverlay">
  <div class="login-container">
    <h2><i class="fas fa-lock"></i> рк╕рлБрк░ркХрлНрк╖рк┐ркд рккрлНрк░рк╡рлЗрк╢</h2>
    <p>ркЖ ркПрккрлНрк▓рк┐ркХрлЗрк╢рки рккрк╛рк╕рк╡рк░рлНркб ркжрлНрк╡рк╛рк░рк╛ рк╕рлБрк░ркХрлНрк╖рк┐ркд ркЫрлЗ. рккрк╛рк╕рк╡рк░рлНркб ркорк╛ркЯрлЗ рк╕ркВрккрк░рлНркХ ркХрк░рлЛ: 9276505035</p>
    <input type="password" id="passwordInput" placeholder="рккрк╛рк╕рк╡рк░рлНркб ркжрк╛ркЦрк▓ ркХрк░рлЛ" autocomplete="off">
    <button id="loginBtn">рккрлНрк░рк╡рлЗрк╢ ркХрк░рлЛ</button>
    <p id="loginError">ркЦрлЛркЯрлЛ рккрк╛рк╕рк╡рк░рлНркб! рклрк░рлАркерлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ.</p>
  </div>
</div>

<div id="mainApp">
  <div class="theme-toggle-container">
    <button class="btn-close-app" id="closeAppBtn" title="ркПрккрлНрк▓рк┐ркХрлЗрк╢рки ркмркВркз ркХрк░рлЛ">
        <i class="fas fa-power-off"></i>
    </button>
    <div class="theme-toggle" id="themeToggle">
      <div class="theme-toggle-circle">
        <i class="fas fa-sun" id="themeIcon"></i>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="header-icon">
      <i class="fas fa-child"></i>
    </div>
    <h1>ркмрк╛рк│ркХ ркорк╛рк╣рк┐ркдрлА рк╡рлНркпрк╡рк╕рлНркерк╛рккрки рккрлНрк░ркгрк╛рк▓рлА</h1>

    <div class="success-message" id="successMessage">
      <i class="fas fa-check-circle"></i>
      <span id="successText">ркорк╛рк╣рк┐ркдрлА рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ рк╕рк╛ркЪрк╡рлА ркЧркИ!</span>
    </div>
    <div class="error-message" id="errorMessage">
      <i class="fas fa-times-circle"></i>
      <span id="errorText">ркорк╛рк╣рк┐ркдрлА Import ркХрк░рк╡рк╛ркорк╛ркВ ркнрлВрк▓!</span>
    </div>

    <div class="form-card">
      <div class="form-title">
        <i class="fas fa-user-plus"></i>
        ркмрк╛рк│ркХркирлА ркорк╛рк╣рк┐ркдрлА ркЙркорлЗрк░рлЛ / ркЕрккркбрлЗркЯ ркорк╛рккркгрлА
      </div>
      <form id="childForm">
        <input type="hidden" id="editId">
        
        <div class="form-group">
          <label for="name"><i class="fas fa-user"></i> ркмрк╛рк│ркХркирлБркВ ркирк╛рко</label>
          <input id="name" type="text" required placeholder="ркмрк╛рк│ркХркирлБркВ рккрлВрк░рлБркВ ркирк╛рко рк▓ркЦрлЛ">
        </div>
        <div class="form-group">
          <label for="motherName"><i class="fas fa-female"></i> ркорк╛ркдрк╛ркирлБркВ ркирк╛рко</label>
          <input id="motherName" type="text" required placeholder="ркорк╛ркдрк╛ркирлБркВ рккрлВрк░рлБркВ ркирк╛рко">
        </div>
        <div class="form-group">
          <label for="dob"><i class="fas fa-calendar-alt"></i> ркЬркирлНркоркдрк╛рк░рлАркЦ</label>
          <div class="date-input-wrapper">
            <input id="dob" type="date" required>
            <span class="date-display" id="dobDisplay"></span>
          </div>
        </div>

        <div class="form-group">
          <label for="sex"><i class="fas fa-venus-mars"></i> рк▓рк┐ркВркЧ</label>
          <select id="sex" required>
            <option value="">рккрк╕ркВркж ркХрк░рлЛ</option>
            <option value="boy">ркЫрлЛркХрк░рлЛ</option>
            <option value="girl">ркЫрлЛркХрк░рлА</option>
          </select>
        </div>
        <div class="form-group">
          <label for="mobileNumber"><i class="fas fa-mobile-alt"></i> ркорлЛркмрк╛ркЗрк▓ ркиркВркмрк░</label>
          <input id="mobileNumber" type="tel" placeholder="10 ркЕркВркХркирлЛ ркорлЛркмрк╛ркЗрк▓ ркиркВркмрк░">
        </div>
        <div class="form-group">
          <label for="aadhaarNumber"><i class="fas fa-id-card"></i> ркЖркзрк╛рк░ ркиркВркмрк░</label>
          <input id="aadhaarNumber" type="text" placeholder="12 ркЕркВркХркирлЛ ркЖркзрк╛рк░ ркиркВркмрк░">
        </div>

        <div class="form-group">
          <label for="apaarId"><i class="fas fa-address-card"></i> ркЕрккрк╛рк░ ID</label>
          <input id="apaarId" type="text" placeholder="ркЬрлЛ рк╣рлЛркп ркдрлЛ">
        </div>
        <div class="form-group">
          <label for="abhaId"><i class="fas fa-hospital"></i> ркЖркнрк╛ ID</label>
          <input id="abhaId" type="text" placeholder="ркЬрлЛ рк╣рлЛркп ркдрлЛ">
        </div>
        <div class="form-group">
          <label for="weightDate"><i class="fas fa-calendar-check"></i> рк╡ркЬрки/ркКркВркЪрк╛ркИ ркорк╛рккркгрлА ркдрк╛рк░рлАркЦ</label>
          <div class="date-input-wrapper">
            <input id="weightDate" type="date" required>
            <span class="date-display" id="weightDateDisplay"></span>
          </div>
        </div>

        <div class="form-group">
          <label for="weight"><i class="fas fa-weight"></i> рк╡ркЬрки (ркХрк┐ркЧрлНрк░рк╛)</label>
          <input id="weight" type="number" step="0.1" required placeholder="ркЙркжрк╛рк╣рк░ркг: 6.5">
        </div>
        <div class="form-group">
          <label for="height"><i class="fas fa-ruler-vertical"></i> ркКркВркЪрк╛ркИ (рк╕рлЗркорлА)</label>
          <input id="height" type="number" step="0.1" required placeholder="ркЙркжрк╛рк╣рк░ркг: 65.2">
        </div>
        <div class="form-group"></div> 

        <button class="btn-primary" type="submit">
          <i class="fas fa-save"></i>
          ркмрк╛рк│ркХ ркорк╛рк╣рк┐ркдрлА/ркорк╛рккркгрлА ркЙркорлЗрк░рлЛ
        </button>
      </form>
    </div>

    <div class="filters-card">
      <div class="filters-title">
        <i class="fas fa-filter"></i>
        рклрк┐рк▓рлНркЯрк░рлНрк╕ ркЕркирлЗ ркПркХрлНрк╕рккрлЛрк░рлНркЯ
      </div>
      <div class="filters">
        <div style="display:flex; flex-direction:column; gap:8px;">
          <div id="dtButtons"></div>
          <div class="custom-action-buttons">
              <button class="btn" id="exportBtn"><i class="fas fa-file-export"></i> ркбрлЗркЯрк╛ Export (JSON)</button>
              <input type="file" id="importFile" accept="application/json">
              <button class="btn" id="importBtn"><i class="fas fa-file-import"></i> ркбрлЗркЯрк╛ Import (JSON)</button>
          </div>
        </div>

        <div class="filter-options">
          
          <div class="custom-dropdown">
              <button type="button" class="dropdown-btn" id="ageGroupDropdownBtn">
                  <span id="ageGroupLabel">ркЙркВркорк░ ркЬрлВркеркерлА рклрк┐рк▓рлНркЯрк░ ркХрк░рлЛ</span>
                  <i class="fas fa-caret-down"></i>
              </button>
              <div class="dropdown-content" id="ageGroupDropdownContent">
                  <div class="checkbox-group">
                      <label><input type="checkbox" class="age-filter-checkbox" value="(0-6mnth)"> 0-6 ркорк╣рк┐ркирк╛</label>
                      <label><input type="checkbox" class="age-filter-checkbox" value="(6-1yr)"> 6-12 ркорк╣рк┐ркирк╛</label>
                      <label><input type="checkbox" class="age-filter-checkbox" value="(1-3 yr)"> 1-3 рк╡рк░рлНрк╖</label>
                      <label><input type="checkbox" class="age-filter-checkbox" value="(3-5 yr)"> 3-5 рк╡рк░рлНрк╖</label>
                      <label><input type="checkbox" class="age-filter-checkbox" value="(5-6 yr)"> 5-6 рк╡рк░рлНрк╖</label>
                  </div>
              </div>
          </div>

          <select id="sexFilter" title="рк▓рк┐ркВркЧркерлА рклрк┐рк▓рлНркЯрк░">
            <option value="">ркмркзрк╛ (рк▓рк┐ркВркЧ)</option>
            <option value="boy">ркЫрлЛркХрк░рлЛ</option>
            <option value="girl">ркЫрлЛркХрк░рлА</option>
          </select>
        </div>
      </div>
    </div>

    <div class="table-card">
      <div class="table-header">
        <div class="table-title">
          <i class="fas fa-table"></i>
          ркмрк╛рк│ркХрлЛркирлА ркорк╛рк╣рк┐ркдрлА
        </div>
        <div class="records-selector">
          <label for="recordsPerPage">рккрлНрк░ркдрк┐ рккрлЗркЬ:</label>
          <select id="recordsPerPage">
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="20">20</option>
          </select>
        </div>
      </div>
      <div class="loader" id="tableLoader"></div>
      <div class="table-wrap">
        <div class="table-wrap-inner" style="margin-top:10px">
          <table id="childTable" class="display" style="width:100%">
            <thead>
              <tr>
                <th>ркХрлНрк░рко</th>
                <th>ркмрк╛рк│ркХркирлБркВ ркирк╛рко</th>
                <th>ркорк╛ркдрк╛ркирлБркВ ркирк╛рко</th>
                <th>рк▓рк┐ркВркЧ</th>
                <th>ркЬркирлНркоркдрк╛рк░рлАркЦ</th>
                <th>ркЙркВркорк░</th>
                <th>ркЙркВркорк░ркЬрлВрке</th>
                <th>ркорлЛркмрк╛ркЗрк▓</th>
                <th>ркЫрлЗрк▓рлНрк▓рлА ркорк╛рккркгрлА ркдрк╛рк░рлАркЦ</th>
                <th>рк╡ркЬрки (ркХрк┐ркЧрлНрк░рк╛)</th>
                <th>ркКркВркЪрк╛ркИ (рк╕рлЗркорлА)</th>
                <th>ркЧрлНрк░рлЗркб</th>
                <th>рк╡ркЬрки рккрлНрк░ркЧркдрк┐</th>
                <th>ркХрлНрк░рк┐ркпрк╛</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="disclaimer-box">
        <h3><i class="fas fa-exclamation-triangle"></i> рк╕рлНрккрк╖рлНркЯркдрк╛ (Disclaimer)</h3>
        <p>ркЧрлНрк░рлЗркбрк┐ркВркЧ Logic ркирлАркЪрлЗ ркорлБркЬркмркирк╛ **BMI рккрлЗрк░рк╛ркорлАркЯрк░** ркорлБркЬркм рк▓рлАркзрлЗрк▓ ркЫрлЗ. ркЖ ркХркЯркУрклрлНрк╕ ркдркорк╛рк░рк╛ рк╡рк┐ркнрк╛ркЧ ркжрлНрк╡рк╛рк░рк╛ ркорк│рлЗрк▓ ркбрлЗркЯрк╛ ркЕркирлЗ рк░рк┐рккрлЛрк░рлНркЯрк┐ркВркЧ ркЬрк░рлВрк░рк┐ркпрк╛ркд ркорлБркЬркм ркПркбркЬрк╕рлНркЯ ркХрк░рк╡рк╛ркорк╛ркВ ркЖрк╡рлНркпрк╛ ркЫрлЗ ркЕркирлЗ ркдрлЗ ркЕркирлНркп рк╕ркдрлНркдрк╛рк╡рк╛рк░ рк╕рк░ркХрк╛рк░рлА ркПрккрлНрк▓рк┐ркХрлЗрк╢ркирлЛ/ркорк╛рк░рлНркЧркжрк░рлНрк╢рк┐ркХрк╛ркУркерлА **ркЕрк▓ркЧ** рк╣рлЛркИ рк╢ркХрлЗ ркЫрлЗред</p>
        <table class="disclaimer-table">
            <thead>
                <tr>
                    <th>ркЧрлНрк░рлЗркб</th>
                    <th>ркирк╡рлА BMI ркорк░рлНркпрк╛ркжрк╛</th>
                    <th>рк╕ркоркЬрлВркдрлА</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="pill bad">ркЧркВркнрлАрк░ (рк▓рк╛рк▓)</span></td>
                    <td>BMI < 13.5</td>
                    <td>ркЕркдрлНркпркВркд ркУркЫрлБркВ рк╡ркЬрки (ркЬрлЗрко ркХрлЗ SAM ркХрлЗркЯрлЗркЧрк░рлАркорк╛ркВ)</td>
                </tr>
                <tr>
                    <td><span class="pill warn">рк╕рк╛ркорк╛ркирлНркп (рккрлАрк│рлЛ)</span></td>
                    <td>13.5 $\le$ BMI < 14.5</td>
                    <td>ркоркзрлНркпрко рккрлЛрк╖ркгркирлА ркЙркгркк</td>
                </tr>
                <tr>
                    <td><span class="pill ok">ркдркВркжрлБрк░рк╕рлНркд (рк▓рлАрк▓рлЛ)</span></td>
                    <td>BMI $\ge$ 14.5</td>
                    <td>рк╕рк╛ркорк╛ркирлНркп/ркдркВркжрлБрк░рк╕рлНркд рк╡ркЬрки</td>
                </tr>
            </tbody>
        </table>
    </div>

    <footer>
      <i class="fas fa-code"></i> рк╡рк┐ркХрк╕рк┐ркд ркХрк░рлНркпрлБркВ: ркжрлЗрк╡рлЗркирлНркжрлНрк░ рк░рк╛ркорк╛ркирлБркЬ тАв 9276505035 ЁЯЩП
    </footer>
  </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2 id="modalChildName">ркорк╛рккркгрлА ркЗркдрк┐рк╣рк╛рк╕</h2>
        <table class="modal-table">
            <thead>
                <tr>
                    <th>ркдрк╛рк░рлАркЦ</th>
                    <th>рк╡ркЬрки (ркХрк┐ркЧрлНрк░рк╛)</th>
                    <th>ркКркВркЪрк╛ркИ (рк╕рлЗркорлА)</th>
                    <th>ркЧрлНрк░рлЗркб</th>
                </tr>
            </thead>
            <tbody id="historyTableBody">
                </tbody>
        </table>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
/* -------------------------
   PASSWORD PROTECTION LOGIC
   ------------------------- */
// *** CHANGE YOUR PASSWORD HERE ***
const CORRECT_PASSWORD = "0000"; 

// Wait for DOM to be fully loaded
window.onload = function() {
  const passwordOverlay = document.getElementById('passwordOverlay');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');
  const mainApp = document.getElementById('mainApp');

  // Function to check password
  function checkPassword() {
    const enteredPassword = passwordInput.value.trim();
    
    if (enteredPassword === CORRECT_PASSWORD) {
      passwordOverlay.style.display = 'none';
      mainApp.style.display = 'block';
      loginError.style.display = 'none';
      // Initialize app after successful login
      initializeApp();
    } else {
      loginError.style.display = 'block';
      passwordInput.value = '';
      passwordInput.focus();
    }
  }

  // Add event listeners
  loginBtn.addEventListener('click', checkPassword);
  
  passwordInput.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
      checkPassword();
    }
  });

  // Focus on password input
  passwordInput.focus();
};

/* -------------------------
   INITIALIZE APP AFTER LOGIN
   ------------------------- */
function initializeApp() {
  // Initialize theme toggle
  const currentTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', currentTheme);
  
  const themeIcon = document.getElementById('themeIcon');
  if (currentTheme === 'dark') {
    themeIcon.classList.remove('fa-sun');
    themeIcon.classList.add('fa-moon');
  }
  
  const themeToggle = document.getElementById('themeToggle');
  themeToggle.addEventListener('click', function() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    if (newTheme === 'dark') {
      themeIcon.classList.remove('fa-sun');
      themeIcon.classList.add('fa-moon');
    } else {
      themeIcon.classList.remove('fa-moon');
      themeIcon.classList.add('fa-sun');
    }
  });

  // Close App Button Logic
  const closeAppBtn = document.getElementById('closeAppBtn');
  if (closeAppBtn) {
    closeAppBtn.addEventListener('click', function() {
      const confirmClose = confirm("рк╢рлБркВ ркдркорлЗ ркПрккрлНрк▓рк┐ркХрлЗрк╢рки ркмркВркз ркХрк░рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?");
      if (confirmClose) {
        // Reload page to show password overlay again
        location.reload();
      }
    });
  }

  // Initialize date display listeners
  initializeDateDisplays();

  // Set today's date as default for weightDate
  const today = new Date().toISOString().split('T')[0];
  $('#weightDate').val(today);
  updateDateDisplay('weightDate', 'weightDateDisplay');


  // Initialize rest of app
  renderTableRefresh();
}

/* -------------------------
   DATE FORMAT FUNCTIONS
   ------------------------- */
// Function to format date from YYYY-MM-DD to DD/MM/YYYY
function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
        const [year, month, day] = dateStr.split('-');
        // Ensure day and month are padded for consistent DD/MM/YYYY format
        return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
    } catch (e) {
        return dateStr; // return original if parsing fails
    }
}

// Function to format date from DD/MM/YYYY to YYYY-MM-DD (Used only if needed to go back to input format)
function formatDateForInput(dateStr) {
    if (!dateStr) return '';
    try {
        const [day, month, year] = dateStr.split('/');
        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    } catch (e) {
        return dateStr; // return original if parsing fails
    }
}

// Function to update date display
function updateDateDisplay(inputId, displayId) {
    const input = document.getElementById(inputId);
    const display = document.getElementById(displayId);
    
    if (input.value) {
        display.textContent = formatDate(input.value);
        display.style.display = 'block';
    } else {
        display.style.display = 'none';
    }
}

// Initialize date displays
function initializeDateDisplays() {
    // Date of birth
    const dobInput = document.getElementById('dob');
    const dobDisplay = document.getElementById('dobDisplay');
    
    dobInput.addEventListener('change', function() {
        updateDateDisplay('dob', 'dobDisplay');
    });
    
    // Weight date
    const weightDateInput = document.getElementById('weightDate');
    const weightDateDisplay = document.getElementById('weightDateDisplay');
    
    weightDateInput.addEventListener('change', function() {
        updateDateDisplay('weightDate', 'weightDateDisplay');
    });
}

/* -------------------------
   LocalStorage helpers
   ------------------------- */
function getChildren(){ 
  // Initialize 'measurements' array if not present, for compatibility with old data structure
  const children = JSON.parse(localStorage.getItem('childrenData')||'[]');
  return children.map(child => {
    // Check if the old single measurement structure exists (only if 'measurements' array is missing)
    if (!child.measurements || !Array.isArray(child.measurements)) {
      const measurement = {
        date: child.weightDate || '',
        weight: child.weight !== undefined ? child.weight : null,
        height: child.height !== undefined ? child.height : null,
      };
      
      // Clean up old properties if they exist
      delete child.weight;
      delete child.height;
      delete child.weightDate;

      // Add the measurements array (only if there was old data to convert)
      child.measurements = measurement.date ? [measurement] : [];
    }
    return child;
  });
}

function setChildren(arr){ localStorage.setItem('childrenData', JSON.stringify(arr)); }

/* -------------------------
   Utils: age, group, grade
   ------------------------- */
function calculateAge(dobStr){
  if(!dobStr) return '';
  const dob = new Date(dobStr);
  const today = new Date();
  let years = today.getFullYear() - dob.getFullYear();
  let months = today.getMonth() - dob.getMonth();
  if (today.getDate() < dob.getDate()) months--;
  if (months < 0) { years--; months += 12; }
  
  if (years < 0) return 'ркнрлВрк▓'; // Handle future date errors
  
  return `${years} рк╡рк░рлНрк╖, ${months} ркорк╣рк┐ркирк╛`;
}
function calculateAgeGroup(dobStr){
  if(!dobStr) return '';
  const dob = new Date(dobStr), today = new Date();
  let totalMonths = (today.getFullYear()-dob.getFullYear())*12 + (today.getMonth()-dob.getMonth());
  if (today.getDate() < dob.getDate()) totalMonths--;
  
  if (totalMonths < 0) return 'ркнрлВрк▓';

  if (totalMonths <= 6) return "(0-6mnth)";
  if (totalMonths <= 12) return "(6-1yr)";
  if (totalMonths <= 36) return "(1-3 yr)";
  if (totalMonths <= 60) return "(3-5 yr)";
  if (totalMonths <= 72) return "(5-6 yr)";
  return "";
}

/**
 * ркЧрлНрк░рлЗркбрк┐ркВркЧ рк▓рлЛркЬрк┐ркХ. (BMI)
 */
function calculateGrade(weight, height){
  const h = Number(height);
  const w = Number(weight);
  
  if (!h || !w || isNaN(h) || isNaN(w) || h <= 0) return { text: '-', cls: '' };

  const heightMeters = h / 100;
  const bmi = w / (heightMeters * heightMeters);

  // ркХркЯркУрклрлНрк╕: BMI < 13.5 (Bad), 13.5 <= BMI < 14.5 (Warn), BMI >= 14.5 (OK)
  if (bmi < 13.5) {
    return { text: 'ркЧркВркнрлАрк░', cls: 'pill bad' }; 
  } else if (bmi < 14.5) {
    return { text: 'рк╕рк╛ркорк╛ркирлНркп', cls: 'pill warn' }; 
  } else {
    return { text: 'ркдркВркжрлБрк░рк╕рлНркд', cls: 'pill ok' }; 
  }
}

/**
 * рккрлНрк░ркЧркдрк┐ркирлА ркЧркгркдрк░рлА (рк╡ркЬрки)
 */
function calculateProgress(measurements, latestDate) {
    if (!measurements || measurements.length < 2) {
        return { text: 'ркирк╡рлЛ рк░рлЗркХрлЛрк░рлНркб', cls: '' };
    }

    // Sort measurements by date descending (most recent first)
    const sortedMeasurements = [...measurements].sort((a, b) => new Date(b.date) - new Date(a.date));

    // Find the latest valid measurement matching the latestDate
    const latest = sortedMeasurements.find(m => m.date === latestDate);
    if (!latest || latest.weight === null || latest.weight === undefined) {
        return { text: 'N/A', cls: '' };
    }

    const latestIndex = sortedMeasurements.findIndex(m => m.date === latestDate);

    // Find the 'previous month' measurement: the most recent valid weight measurement
    // that is at least 30 days older than the 'latest' measurement.
    let previousMonthMeasurement = null;
    const latestTimestamp = new Date(latest.date).getTime();
    const thirtyDaysAgo = latestTimestamp - (30 * 24 * 60 * 60 * 1000);

    for (let i = latestIndex + 1; i < sortedMeasurements.length; i++) {
        const currentM = sortedMeasurements[i];
        const currentTimestamp = new Date(currentM.date).getTime();
        
        // Ensure weight is valid and measurement date is at least 30 days older
        if (currentM.weight !== null && currentM.weight !== undefined && currentTimestamp < thirtyDaysAgo) {
            previousMonthMeasurement = currentM;
            break;
        }
    }

    if (!previousMonthMeasurement) {
        return { text: 'ркирк╡рлЛ рк░рлЗркХрлЛрк░рлНркб', cls: '' };
    }

    const latestWeight = Number(latest.weight);
    const prevWeight = Number(previousMonthMeasurement.weight);

    if (isNaN(latestWeight) || isNaN(prevWeight)) {
        return { text: 'рк╡ркЬрки ркЦрлВркЯрлЗ ркЫрлЗ', cls: '' };
    }
    
    const diff = latestWeight - prevWeight;
    const diffText = Math.abs(diff).toFixed(1) + ' ркХрк┐ркЧрлНрк░рк╛';

    if (diff > 0.1) {
        return { 
            text: `+${diffText}`, 
            cls: 'progress-indicator increase',
            icon: 'тЦ▓' 
        };
    } else if (diff < -0.1) {
        return { 
            text: `-${diffText}`, 
            cls: 'progress-indicator decrease',
            icon: 'тЦ╝' 
        };
    } else {
        return { 
            text: 'ркХрлЛркИ рклрлЗрк░рклрк╛рк░ ркирк╣рлАркВ', 
            cls: 'progress-indicator same',
            icon: 'тАУ' 
        };
    }
}


/* -------------------------
   Show messages
   ------------------------- */
function showSuccessMessage(message) {
  $('#successText').text(message);
  $('#successMessage').fadeIn().delay(2000).fadeOut();
}
function showErrorMessage(message) {
  $('#errorText').text(message);
  $('#errorMessage').fadeIn().delay(3000).fadeOut();
}

/* -------------------------
   DataTable initialization
   ------------------------- */
let table;
function initDataTable(){
  if ($.fn.DataTable.isDataTable('#childTable')) {
    table.clear().draw();
    table.destroy();
  }

  const isMobile = window.innerWidth < 768;
  const recordsPerPage = $('#recordsPerPage').val() || 10;

  table = $('#childTable').DataTable({
    dom: isMobile ? 'Brtip' : 'lBrtip',
    buttons: [
      { extend: 'excelHtml5', text: '<i class="fas fa-file-excel"></i> ркПркХрлНрк╕рлЗрк▓' },
      { extend: 'pdfHtml5', text: '<i class="fas fa-file-pdf"></i> рккрлАркбрлАркПркл' },
      { extend: 'print', text: '<i class="fas fa-print"></i> ркЫрк╛рккрлЛ' },
      { extend: 'colvis', text: '<i class="fas fa-columns"></i> ркХрлЙрк▓рко' }
    ],
    // 14 total columns (excluding Aadhaar, Apaar, Abha for brevity in mobile)
    columnDefs: [
      { targets: 13, orderable: false } // Action column
    ],
    paging: true,
    pageLength: parseInt(recordsPerPage),
    lengthChange: !isMobile,
    lengthMenu: [[10, 15, 20], [10, 15, 20]],
    info: true,
    language: { 
      emptyTable: "ркХрлЛркИ рк░рлЗркХрлЛрк░рлНркб ркорк│рлНркпрк╛ ркиркерлА",
      info: "ркХрлБрк▓ _START_ ркерлА _END_ ркирк╛ _TOTAL_ рк░рлЗркХрлЛрк░рлНркб",
      paginate: {
        first: "рккрлНрк░ркерко",
        last: "ркЕркВркдрк┐рко",
        next: "ркЖркЧрк│",
        previous: "рккрк╛ркЫрк│"
      },
      lengthMenu: "рккрлНрк░ркдрк┐ рккрлЗркЬ _MENU_ рк░рлЗркХрлЛрк░рлНркб ркмркдрк╛рк╡рлЛ"
    },
    responsive: true
  });

  table.buttons().container().appendTo('#dtButtons');
}

/* -------------------------
   Render rows from storage
   ------------------------- */
function renderRows(){
  $('#tableLoader').show();
  initDataTable();
  const data = getChildren();
  data.forEach((c, idx) => {
    // Get latest measurement
    const measurements = c.measurements || [];
    const latestMeasurement = measurements.length > 0 
      ? measurements[0] // Since measurements are sorted descending in the save step
      : { date: '', weight: null, height: null };

    const grade = calculateGrade(latestMeasurement.weight, latestMeasurement.height);
    const progress = calculateProgress(measurements, latestMeasurement.date);
    const ageGroupText = calculateAgeGroup(c.dob); 
    
    // Check if measurement fields are empty
    const weightDisplay = latestMeasurement.weight !== undefined && latestMeasurement.weight !== null ? latestMeasurement.weight : '-';
    const heightDisplay = latestMeasurement.height !== undefined && latestMeasurement.height !== null ? latestMeasurement.height : '-';

    // The 'action' column includes the history button now
    const actionCell = `
      <button class="action-btn edit" data-id="${c.id}"><i class="fas fa-edit"></i> рк╕рлБркзрк╛рк░рлЛ</button>
      <button class="action-btn del" data-id="${c.id}"><i class="fas fa-trash"></i> ркХрк╛ркврлЛ</button>
      <button class="measurement-history-btn" data-id="${c.id}" data-name="${c.name}">
          <i class="fas fa-history"></i> ркЗркдрк┐рк╣рк╛рк╕ (${measurements.length})
      </button>
    `;

    const row = [
      idx + 1,
      c.name || '',
      c.motherName || '',
      c.sex === 'boy' ? 'ркЫрлЛркХрк░рлЛ' : (c.sex === 'girl' ? 'ркЫрлЛркХрк░рлА' : ''),
      formatDate(c.dob), // Display in DD/MM/YYYY format
      calculateAge(c.dob),
      ageGroupText, // Column index 6
      c.mobileNumber || '',
      // New columns for latest measurement
      formatDate(latestMeasurement.date), // Column index 8
      weightDisplay, // Column index 9
      heightDisplay, // Column index 10
      `<span class="${grade.cls}">${grade.text}</span>`, // Column index 11
      `<span class="${progress.cls}">${progress.text} ${progress.icon || ''}</span>`, // Column index 12
      actionCell // Column index 13
    ];
    table.row.add(row).draw(false);
  });
  $('#tableLoader').hide();

  // Setup event listeners for edit, delete and history buttons
  setupTableEventListeners();
}

/* -------------------------
   Setup Table Event Listeners
   ------------------------- */
function setupTableEventListeners() {
  // Remove existing event listeners to prevent duplicates
  $('#childTable tbody').off('click', '.edit, .del, .measurement-history-btn');
  
  // Add new event listeners
  $('#childTable tbody').on('click', '.edit', function(e){
    e.preventDefault();
    const id = Number($(this).data('id')); 
    startEdit(id);
  });
  
  $('#childTable tbody').on('click', '.del', function(e){
    e.preventDefault();
    const id = Number($(this).data('id')); 
    confirmDelete(id);
  });

  $('#childTable tbody').on('click', '.measurement-history-btn', function(e){
    e.preventDefault();
    const id = Number($(this).data('id')); 
    const name = $(this).data('name');
    showMeasurementHistory(id, name);
  });
}

/* -------------------------
   Modal Logic for History
   ------------------------- */
const modal = document.getElementById("historyModal");
const closeBtn = document.querySelector(".modal-close");

closeBtn.onclick = function() {
    modal.style.display = "none";
}

window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

function showMeasurementHistory(id, name) {
    const children = getChildren();
    const child = children.find(c => c.id === id);
    const historyBody = document.getElementById('historyTableBody');
    historyBody.innerHTML = '';
    
    if (!child || !child.measurements || child.measurements.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ркХрлЛркИ ркорк╛рккркгрлА ркЗркдрк┐рк╣рк╛рк╕ ркиркерлА.</td></tr>';
    } else {
        // Measurements array is already sorted descending by date from the save step
        const sortedMeasurements = child.measurements;
        
        sortedMeasurements.forEach(m => {
            const grade = calculateGrade(m.weight, m.height);
            const row = historyBody.insertRow();
            
            row.insertCell().textContent = formatDate(m.date);
            row.insertCell().textContent = m.weight !== undefined && m.weight !== null ? m.weight + ' ркХрк┐ркЧрлНрк░рк╛' : '-';
            row.insertCell().textContent = m.height !== undefined && m.height !== null ? m.height + ' рк╕рлЗркорлА' : '-';
            row.insertCell().innerHTML = `<span class="${grade.cls}">${grade.text}</span>`;
        });
    }

    document.getElementById('modalChildName').textContent = `${name} - ркорк╛рккркгрлА ркЗркдрк┐рк╣рк╛рк╕`;
    modal.style.display = "block";
}


/* -------------------------
   Form handlers: add / edit
   ------------------------- */
 $('#childForm').on('submit', function(e){
  e.preventDefault();
  const editId = $('#editId').val();
  const name = $('#name').val().trim();
  const motherName = $('#motherName').val().trim();
  const sex = $('#sex').val();
  const dob = $('#dob').val(); 
  const mobileNumber = $('#mobileNumber').val().trim();
  const aadhaarNumber = $('#aadhaarNumber').val().trim();
  const apaarId = $('#apaarId').val().trim();
  const abhaId = $('#abhaId').val().trim();
  const weightDate = $('#weightDate').val(); 
  const weight = $('#weight').val();
  const height = $('#height').val();

  let arr = getChildren();
  let childIndex = editId ? arr.findIndex(x => x.id === Number(editId)) : -1;
  let child = childIndex !== -1 ? arr[childIndex] : null;

  // Measurement is valid only if date, weight AND height are present
  const isMeasurementValid = weightDate && weight && height;

  const newMeasurement = {
      date: weightDate,
      weight: weight ? Number(weight) : null,
      height: height ? Number(height) : null,
  };

  if (child) {
    // --- Existing Child: Update Basic Info and Measurements ---
    
    // 1. Update basic info regardless of measurement fields
    child.name = name;
    child.motherName = motherName;
    child.sex = sex;
    child.dob = dob;
    child.mobileNumber = mobileNumber;
    child.aadhaarNumber = aadhaarNumber;
    child.apaarId = apaarId;
    child.abhaId = abhaId;
    
    let isMeasurementUpdated = false;

    if (isMeasurementValid) {
        let measurementIndex = child.measurements.findIndex(m => m.date === weightDate);
        
        if (measurementIndex !== -1) {
            // Update existing measurement for the same date
            child.measurements[measurementIndex] = newMeasurement;
            showSuccessMessage('ркмрк╛рк│ркХркирлА ркорк╛рк╣рк┐ркдрлА ркЕркирлЗ ркорк╛рккркгрлА рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркЕрккркбрлЗркЯ ркХрк░рк╛ркИ!');
            isMeasurementUpdated = true;
        } else {
            // Add new measurement
            child.measurements.push(newMeasurement);
            showSuccessMessage('ркирк╡рлА ркорк╛рккркгрлА рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркЙркорлЗрк░рк╛ркИ!');
            isMeasurementUpdated = true;
        }
    } else if (editId) {
        showSuccessMessage('ркмрк╛рк│ркХркирлА ркорлВрк│ркнрлВркд ркорк╛рк╣рк┐ркдрлА рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркЕрккркбрлЗркЯ ркХрк░рк╛ркИ!');
    }
  } else {
    // --- New Child: Create New Record ---
    child = {
      id: Date.now(),
      name: name,
      motherName: motherName,
      sex: sex,
      dob: dob,
      mobileNumber: mobileNumber,
      aadhaarNumber: aadhaarNumber,
      apaarId: apaarId,
      abhaId: abhaId,
      measurements: isMeasurementValid ? [newMeasurement] : []
    };
    arr.push(child);
    showSuccessMessage('ркирк╡рк╛ ркмрк╛рк│ркХркирлА ркорк╛рк╣рк┐ркдрлА рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркЙркорлЗрк░рк╛ркИ!');
  }
  
  // Sort measurements by date descending (most recent first) before saving
  if(child && child.measurements) {
      child.measurements.sort((a, b) => new Date(b.date) - new Date(a.date));
  }
  
  setChildren(arr);
  this.reset(); 
  $('#editId').val('');
  // Clear date displays and set default for next entry
  document.getElementById('dobDisplay').style.display = 'none';
  const today = new Date().toISOString().split('T')[0];
  $('#weightDate').val(today);
  updateDateDisplay('weightDate', 'weightDateDisplay');

  renderTableRefresh();
});

/* -------------------------
   Edit & Delete
   ------------------------- */
function startEdit(id){
  const arr = getChildren();
  const c = arr.find(x => x.id === id);
  if (!c) return;
  
  // Get latest measurement to pre-fill weight/height/date fields
  const latestMeasurement = c.measurements.length > 0 ? c.measurements[0] : { date: '', weight: null, height: null };

  $('#editId').val(c.id);
  $('#name').val(c.name);
  $('#motherName').val(c.motherName);
  $('#sex').val(c.sex);
  $('#dob').val(c.dob);
  $('#mobileNumber').val(c.mobileNumber);
  $('#aadhaarNumber').val(c.aadhaarNumber);
  $('#apaarId').val(c.apaarId);
  $('#abhaId').val(c.abhaId);
  
  // Pre-fill measurement fields with latest data for editing/new entry
  const today = new Date().toISOString().split('T')[0];
  
  // If the latest measurement date is today, pre-fill those values
  if (latestMeasurement.date === today) {
    $('#weightDate').val(latestMeasurement.date);
    $('#weight').val(latestMeasurement.weight || '');
    $('#height').val(latestMeasurement.height || '');
  } else {
    // If last measurement was not today, pre-fill basic info but leave today's date and empty weight/height 
    $('#weightDate').val(today);
    $('#weight').val('');
    $('#height').val('');
  }
  
  // Update date displays for edit mode
  updateDateDisplay('dob', 'dobDisplay');
  updateDateDisplay('weightDate', 'weightDateDisplay');
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function confirmDelete(id){
  const ok = confirm("рк╢рлБркВ ркдркорлЗ ркЖ рк░рлЗркХрлЛрк░рлНркб ркЦрк░рлЗркЦрк░ ркбрк┐рк▓рлАркЯ ркХрк░рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?");
  if (!ok) return;
  
  let arr = getChildren();
  arr = arr.filter(x => x.id !== id);
  
  setChildren(arr);
  showSuccessMessage('ркмрк╛рк│ркХркирлЛ рк░рлЗркХрлЛрк░рлНркб рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркХрк╛ркврлА ркирк╛ркЦрк╛ркпрлЛ!');
  renderTableRefresh();
}

/* -------------------------
   Custom Dropdown Logic
   ------------------------- */
 $('#ageGroupDropdownBtn').on('click', function(e) {
    $('#ageGroupDropdownContent').toggleClass('show');
    e.stopPropagation();
});

// Close dropdown if user clicks outside of it
 $(document).on('click', function(e) {
    if (!$(e.target).closest('.custom-dropdown').length) {
        $('#ageGroupDropdownContent').removeClass('show');
    }
});

// Update dropdown label text
function updateAgeGroupLabel() {
    const checkedCount = $('.age-filter-checkbox:checked').length;
    let labelText = 'ркЙркВркорк░ ркЬрлВркеркерлА рклрк┐рк▓рлНркЯрк░ ркХрк░рлЛ';
    if (checkedCount > 0) {
        labelText = `${checkedCount} ркЬрлВрке рккрк╕ркВркж ркХрк░рлЗрк▓ ркЫрлЗ`;
    }
    $('#ageGroupLabel').text(labelText);
}

// Age Group Checkbox change event
 $('.age-filter-checkbox').on('change', function() {
    updateAgeGroupLabel();
    handleFilterChange();
});
 $('#sexFilter').on('change', handleFilterChange);


/* -------------------------
   Filters: age (checkbox) & sex
   ------------------------- */
function applyFiltersToTable(){
  const selectedAgeGroups = $('.age-filter-checkbox:checked').map(function(){
      return this.value;
  }).get(); 

  const sexVal = $('#sexFilter').val();
  
  // Custom filter function for DataTables
  $.fn.dataTable.ext.search.push(
      function(settings, data, dataIndex) {
          const ageGroup = data[6]; 
          const sex = data[3];       

          let ageMatch = true;
          let sexMatch = true;

          // 1. Age Group Filter
          if (selectedAgeGroups.length > 0) {
              ageMatch = selectedAgeGroups.includes(ageGroup);
          } else {
              ageMatch = true; // Show all if none checked
          }

          // 2. Sex Filter
          if (sexVal && sexVal !== "") {
              sexMatch = (sexVal === 'boy' ? sex === 'ркЫрлЛркХрк░рлЛ' : sex === 'ркЫрлЛркХрк░рлА');
          }
          
          return ageMatch && sexMatch;
      }
  );

  table.draw();
  table.page('first').draw('page');
}

function handleFilterChange() {
    // Clear all existing search functions before adding new ones
    $.fn.dataTable.ext.search.length = 0; 
    applyFiltersToTable();
}

/* -------------------------
   Import/Export Logic
   ------------------------- */

// Export Data to JSON
 $('#exportBtn').on('click', function() {
    const data = getChildren();
    // Remove unnecessary fields from export if needed, but for history tracking, 
    // it's best to export the full object including all measurements.
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'child_data_export_' + new Date().toISOString().slice(0, 10) + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showSuccessMessage('ркбрлЗркЯрк╛ JSON рклрлЛрк░рлНркорлЗркЯркорк╛ркВ рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ Export ркеркпрлЛ!');
});

// Trigger file selection on Import button click
 $('#importBtn').on('click', function() {
    $('#importFile').click();
});

// Import Data from JSON
 $('#importFile').on('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const importedData = JSON.parse(event.target.result);
            if (Array.isArray(importedData)) {
                
                // Basic validation for core fields (checking for ID and name)
                const isValid = importedData.every(item => 
                    item.id !== undefined && item.name !== undefined
                );

                if (isValid || importedData.length === 0) {
                    // Sanitize/Convert data structure upon import to ensure compatibility
                    const sanitizedData = importedData.map(child => {
                        if (!child.measurements || !Array.isArray(child.measurements)) {
                            // Convert old single record format to new measurements array
                            const measurement = {
                                date: child.weightDate || '',
                                weight: child.weight !== undefined ? child.weight : null,
                                height: child.height !== undefined ? child.height : null,
                            };
                            delete child.weight;
                            delete child.height;
                            delete child.weightDate;
                            child.measurements = measurement.date ? [measurement] : [];
                        }
                        // Ensure measurements are sorted after import
                        if(child.measurements) {
                           child.measurements.sort((a, b) => new Date(b.date) - new Date(a.date));
                        }
                        return child;
                    });


                    setChildren(sanitizedData);
                    renderTableRefresh();
                    showSuccessMessage(`ркХрлБрк▓ ${sanitizedData.length} рк░рлЗркХрлЛрк░рлНркб рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ Import ркеркпрк╛!`);
                } else {
                    showErrorMessage('Import ркХрк░рлЗрк▓ рклрк╛ркЗрк▓ркорк╛ркВ ркбрлЗркЯрк╛ рклрлЛрк░рлНркорлЗркЯ ркЕркпрлЛркЧрлНркп ркЫрлЗ (ркХрлЛрк░ рклрлАрк▓рлНркб ркЦрлВркЯрлЗ ркЫрлЗ).');
                }
                
            } else {
                showErrorMessage('ркЕркпрлЛркЧрлНркп JSON рклрлЛрк░рлНркорлЗркЯ: ркбрлЗркЯрк╛ ркПрк░рлЗ (array) рк╣рлЛрк╡рлЛ ркЬрлЛркИркП.');
            }
        } catch (error) {
            console.error("Import Error:", error);
            showErrorMessage('JSON рклрк╛ркЗрк▓ рк╡рк╛ркВркЪрк╡рк╛ркорк╛ркВ ркЕркерк╡рк╛ рккрк╛рк░рк╕ (parse) ркХрк░рк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркеркИ.');
        } finally {
             e.target.value = '';
        }
    };
    reader.readAsText(file);
});


/* -------------------------
   Helper to refresh table
   ------------------------- */
function renderTableRefresh(){
  // рккрк╣рлЗрк▓рк╛ркВ ркмркзрк╛ рклрк┐рк▓рлНркЯрк░рлНрк╕ рк╕рк╛ркл ркХрк░рлЛ
  $.fn.dataTable.ext.search.length = 0; 
  
  const currentPageLength = $('#recordsPerPage').val(); 
  
  if ($.fn.DataTable.isDataTable('#childTable')) {
    table.clear().draw();
    table.destroy();
  }
  
  // ркирк╡рлБркВ ркЯрлЗркмрк▓ ркмркирк╛рк╡рлЛ
  $('#recordsPerPage').val(currentPageLength); 
  renderRows();
  updateAgeGroupLabel(); 
  applyFiltersToTable(); // Apply filters after table is re-initialized
}

/* -------------------------
   Records per page selector
   ------------------------- */
 $('#recordsPerPage').on('change', function() {
  const recordsPerPage = $(this).val();
  if ($.fn.DataTable.isDataTable('#childTable')) {
     table.page.len(recordsPerPage).draw();
  } else {
     renderTableRefresh();
  }
});
</script>
</body>
</html>

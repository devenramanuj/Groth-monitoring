<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ркмрк╛рк│ркХ ркорк╛рк╣рк┐ркдрлА рк╡рлНркпрк╡рк╕рлНркерк╛рккрки рккрлНрк░ркгрк╛рк▓рлА</title>

<!-- DataTables CSS (for buttons/colvis) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  /* CSS Variables for Light Theme (New Green Theme) */
  :root {
    --bg: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
    --card: #ffffff;
    --primary: #28a745; /* Changed from #4a6cf7 */
    --secondary: #20c997; /* Changed from #6c63ff */
    --accent: #ff6b6b;
    --muted: #6c757d;
    --success: #28a745;
    --warning: #ffc107;
    --danger: #dc3545;
    --info: #17a2b8;
    --light: #f8f9fa;
    --dark: #343a40;
    --radius: 12px;
    --shadow: 0 10px 30px rgba(0,0,0,0.1);
    --shadow-sm: 0 4px 6px rgba(0,0,0,0.07);
    --text-color: #333;
    --header-bg: linear-gradient(90deg, var(--primary), var(--secondary)); /* Updated gradient */
    --form-bg: linear-gradient(to right, #ffffff, #f8f9ff);
    --border-color: #eaeef7;
    --table-header-bg: linear-gradient(to right, #f8f9ff, #eaeef7);
    --table-row-hover: #eaeef7;
    --table-row-even: #f8f9ff;
    --footer-bg: linear-gradient(to right, #f8f9ff, #eaeef7);
    --toggle-bg: var(--primary); /* Changed from #4a6cf7 */
    --toggle-circle: #ffffff;
  }

  /* CSS Variables for Dark Theme (New Teal Theme) */
  [data-theme="dark"] {
    --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    --card: #1f2937;
    --primary: #20c997; /* Changed from #7c3aed */
    --secondary: #17a2b8; /* Changed from #8b5cf6 */
    --accent: #f43f5e;
    --muted: #9ca3af;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #06b6d4;
    --light: #374151;
    --dark: #f9fafb;
    --radius: 12px;
    --shadow: 0 10px 30px rgba(0,0,0,0.3);
    --shadow-sm: 0 4px 6px rgba(0,0,0,0.2);
    --text-color: #e5e7eb;
    --header-bg: linear-gradient(90deg, var(--primary), var(--secondary)); /* Updated gradient */
    --form-bg: linear-gradient(to right, #1f2937, #374151);
    --border-color: #374151;
    --table-header-bg: linear-gradient(to right, #374151, #4b5563);
    --table-row-hover: #374151;
    --table-row-even: #2d3748;
    --footer-bg: linear-gradient(to right, #1f2937, #374151);
    --toggle-bg: var(--primary); /* Changed from #7c3aed */
    --toggle-circle: #f9fafb;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color:var(--text-color);
    line-height:1.6;
    padding:20px;
    transition: all 0.3s ease;
  }
  .container{
    max-width:1200px;
    margin:0 auto;
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:30px;
    animation: fadeIn 0.5s ease-in-out;
    transition: all 0.3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Theme Toggle Switch */
  .theme-toggle-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
  }
  
  .theme-toggle {
    position: relative;
    width: 70px;
    height: 34px;
    background: var(--toggle-bg);
    border-radius: 34px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  
  .theme-toggle-circle {
    position: absolute;
    top: 3px;
    left: 3px;
    width: 28px;
    height: 28px;
    background: var(--toggle-circle);
    border-radius: 50%;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .theme-toggle-circle i {
    font-size: 16px;
    color: var(--toggle-bg);
  }
  
  [data-theme="dark"] .theme-toggle-circle {
    transform: translateX(36px);
  }
  
  .theme-toggle:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 8px rgba(0,0,0,0.15);
  }
  
  h1{
    margin:0 0 20px;
    font-size:28px;
    color:var(--primary);
    text-align:center;
    position:relative;
    padding-bottom:15px;
  }
  h1:after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    border-radius: 3px;
  }
  /* Header with icon */
  .header-icon {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
  }
  .header-icon i {
    font-size: 48px;
    color: var(--primary);
    background: rgba(40, 167, 69, 0.1); /* Changed color */
    padding: 15px;
    border-radius: 50%;
    transition: all 0.3s ease;
  }
  
  [data-theme="dark"] .header-icon i {
    background: rgba(32, 201, 151, 0.1); /* Changed color */
  }
  
  /* Form styling */
  .form-card {
    background: var(--form-bg);
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }
  
  .form-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow);
  }
  
  .form-title {
    font-size: 20px;
    color: var(--primary);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
  }
  .form-title i {
    margin-right: 10px;
  }
  form{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:15px;
  }
  @media(max-width:760px){form{grid-template-columns:1fr}}
  .form-group {
    display: flex;
    flex-direction: column;
  }
  label{
    font-size:14px;
    color:var(--text-color);
    margin-bottom:6px;
    font-weight:600;
    display: flex;
    align-items: center;
  }
  label i {
    margin-right: 5px;
    color: var(--primary);
  }
  input[type="text"], input[type="date"], input[type="tel"], input[type="number"], select{
    width:100%;
    padding:12px 15px;
    border:1px solid var(--border-color);
    border-radius:8px;
    background:var(--card);
    font-size:14px;
    color:var(--text-color);
    transition:all 0.3s ease;
  }
  input:focus, select:focus{
    outline:none;
    border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(40, 167, 69, 0.2); /* Changed color */
  }
  
  [data-theme="dark"] input:focus, [data-theme="dark"] select:focus {
    box-shadow:0 0 0 3px rgba(32, 201, 151, 0.2); /* Changed color */
  }
  
  .btn-primary{
    grid-column:1/-1;
    background:linear-gradient(90deg,var(--primary),var(--secondary));
    color:white;
    padding:12px 20px;
    border-radius:8px;
    border:none;
    font-weight:600;
    cursor:pointer;
    font-size:16px;
    transition:all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .btn-primary i {
    margin-right: 8px;
  }
  .btn-primary:hover{
    transform:translateY(-2px);
    box-shadow:0 5px 15px rgba(40, 167, 69, 0.3); /* Changed color */
  }
  
  [data-theme="dark"] .btn-primary:hover {
    box-shadow:0 5px 15px rgba(32, 201, 151, 0.3); /* Changed color */
  }
  
  /* Filters section */
  .filters-card {
    background: var(--form-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }
  
  .filters-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow);
  }
  
  .filters-title {
    font-size: 18px;
    color: var(--primary);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
  }
  .filters-title i {
    margin-right: 10px;
  }
  .filters{
    display:flex;
    gap:15px;
    align-items:center;
    flex-wrap:wrap;
  }
  .filters .left{
    display:flex;
    gap:10px;
    align-items:center;
  }
  .filters select{
    padding:10px 15px;
    border-radius:8px;
    border:1px solid var(--border-color);
    background:var(--card);
    min-width:150px;
    color:var(--text-color);
  }
  /* Table section */
  .table-card {
    background: var(--form-bg);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }
  
  .table-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow);
  }
  
  .table-title {
    font-size: 18px;
    color: var(--primary);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
  }
  .table-title i {
    margin-right: 10px;
  }
  .table-wrap{
    overflow:auto;
    background:var(--card);
    padding:15px;
    border-radius:8px;
    box-shadow:var(--shadow-sm);
  }
  table.dataTable{
    width:100% !important;
    border-collapse:collapse;
  }
  th,td{
    padding:12px 15px;
    border-bottom:1px solid var(--border-color);
    vertical-align:middle;
  }
  th{
    background:var(--table-header-bg);
    font-weight:600;
    color:var(--primary);
    position: sticky;
    top: 0;
  }
  tr:nth-child(even) td{
    background:var(--table-row-even);
  }
  tr:hover td {
    background: var(--table-row-hover);
  }
  /* Grade pills */
  .pill{
    display:inline-block;
    padding:6px 12px;
    border-radius:20px;
    color:white;
    font-weight:600;
    font-size:13px;
  }
  .pill.ok{background:var(--success)}
  .pill.warn{background:var(--warning);color:#333}
  .pill.bad{background:var(--danger)}
  /* Action buttons */
  .action-btn{
    border:none;
    padding:8px 12px;
    border-radius:6px;
    color:#fff;
    font-weight:600;
    cursor:pointer;
    margin-right:5px;
    transition:all 0.3s ease;
  }
  .action-btn i {
    margin-right: 5px;
  }
  .edit{
    background:linear-gradient(90deg,var(--info),#0c7b93);
  }
  .edit:hover{
    transform:translateY(-2px);
    box-shadow:0 4px 8px rgba(23, 162, 184, 0.3);
  }
  .del{
    background:linear-gradient(90deg,var(--danger),#a71e2a);
  }
  .del:hover{
    transform:translateY(-2px);
    box-shadow:0 4px 8px rgba(220, 53, 69, 0.3);
  }
  .dt-button{
    border-radius:8px;
    padding:8px 12px;
    margin-right:8px;
    background:linear-gradient(90deg,var(--primary),var(--secondary));
    border:none;
    color:#fff;
    font-weight:600;
    transition:all 0.3s ease;
  }
  .dt-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3); /* Changed color */
  }
  
  [data-theme="dark"] .dt-button:hover {
    box-shadow: 0 4px 8px rgba(32, 201, 151, 0.3); /* Changed color */
  }
  
  /* Footer */
  footer{
    margin-top:20px;
    text-align:center;
    color:var(--muted);
    font-size:14px;
    padding:15px;
    background: var(--footer-bg);
    border-radius: var(--radius);
    transition: all 0.3s ease;
  }
  /* Responsive adjustments */
  @media(max-width:768px){
    .container{padding:15px;}
    h1{font-size:24px;}
    .form-card, .filters-card, .table-card {
      padding: 15px;
    }
    .theme-toggle-container {
      top: 10px;
      right: 10px;
    }
  }
  @media(max-width:420px){
    .filters{flex-direction:column;align-items:stretch}
    .dt-button{width:100%; margin-bottom:8px}
  }
  /* Loading animation */
  .loader {
    border: 4px solid var(--card);
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
    display: none;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  /* Success message */
  .success-message {
    background: var(--success);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
    align-items: center;
  }
  .success-message i {
    margin-right: 10px;
  }
</style>
</head>
<body>

<div class="theme-toggle-container">
  <div class="theme-toggle" id="themeToggle">
    <div class="theme-toggle-circle">
      <i class="fas fa-sun" id="themeIcon"></i>
    </div>
  </div>
</div>

<div class="container">
  <div class="header-icon">
    <i class="fas fa-child"></i>
  </div>
  <h1>ркмрк╛рк│ркХ ркорк╛рк╣рк┐ркдрлА рк╡рлНркпрк╡рк╕рлНркерк╛рккрки рккрлНрк░ркгрк╛рк▓рлА</h1>

  <!-- Success Message -->
  <div class="success-message" id="successMessage">
    <i class="fas fa-check-circle"></i>
    <span id="successText">ркорк╛рк╣рк┐ркдрлА рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ рк╕рк╛ркЪрк╡рлА ркЧркИ!</span>
  </div>

  <!-- Form Card -->
  <div class="form-card">
    <div class="form-title">
      <i class="fas fa-user-plus"></i>
      ркмрк╛рк│ркХркирлА ркорк╛рк╣рк┐ркдрлА ркЙркорлЗрк░рлЛ
    </div>
    <form id="childForm">
      <input type="hidden" id="editId">
      <div class="form-group">
        <label for="name"><i class="fas fa-user"></i> ркмрк╛рк│ркХркирлБркВ ркирк╛рко</label>
        <input id="name" type="text" required placeholder="ркмрк╛рк│ркХркирлБркВ рккрлВрк░рлБркВ ркирк╛рко рк▓ркЦрлЛ">
      </div>
      <div class="form-group">
        <label for="motherName"><i class="fas fa-female"></i> ркорк╛ркдрк╛ркирлБркВ ркирк╛рко</label>
        <input id="motherName" type="text" required placeholder="ркорк╛ркдрк╛ркирлБркВ рккрлВрк░рлБркВ ркирк╛рко">
      </div>

      <div class="form-group">
        <label for="sex"><i class="fas fa-venus-mars"></i> рк▓рк┐ркВркЧ</label>
        <select id="sex" required>
          <option value="">рккрк╕ркВркж ркХрк░рлЛ</option>
          <option value="boy">ркЫрлЛркХрк░рлЛ</option>
          <option value="girl">ркЫрлЛркХрк░рлА</option>
        </select>
      </div>
      <div class="form-group">
        <label for="dob"><i class="fas fa-calendar-alt"></i> ркЬркирлНркоркдрк╛рк░рлАркЦ</label>
        <input id="dob" type="date" required>
      </div>

      <div class="form-group">
        <label for="mobileNumber"><i class="fas fa-mobile-alt"></i> ркорлЛркмрк╛ркЗрк▓ ркиркВркмрк░</label>
        <input id="mobileNumber" type="tel" placeholder="10 ркЕркВркХркирлЛ ркорлЛркмрк╛ркЗрк▓ ркиркВркмрк░">
      </div>
      <div class="form-group">
        <label for="aadhaarNumber"><i class="fas fa-id-card"></i> ркЖркзрк╛рк░ ркиркВркмрк░</label>
        <input id="aadhaarNumber" type="text" placeholder="12 ркЕркВркХркирлЛ ркЖркзрк╛рк░ ркиркВркмрк░">
      </div>

      <div class="form-group">
        <label for="apaarId"><i class="fas fa-address-card"></i> ркЕрккрк╛рк░ ID</label>
        <input id="apaarId" type="text" placeholder="ркЬрлЛ рк╣рлЛркп ркдрлЛ">
      </div>
      <div class="form-group">
        <label for="abhaId"><i class="fas fa-hospital"></i> ркЖркнрк╛ ID</label>
        <input id="abhaId" type="text" placeholder="ркЬрлЛ рк╣рлЛркп ркдрлЛ">
      </div>

      <!-- Column Moved Here -->
      <div class="form-group">
        <label for="measureDate"><i class="fas fa-calendar-check"></i> рк╡ркЬрки/ркКркВркЪрк╛ркИ ркдрк╛рк░рлАркЦ</label>
        <input id="measureDate" type="date">
      </div>

      <div class="form-group">
        <label for="weight"><i class="fas fa-weight"></i> рк╡ркЬрки (ркХрк┐ркЧрлНрк░рк╛)</label>
        <input id="weight" type="number" step="0.1" required placeholder="ркЙркжрк╛рк╣рк░ркг: 6.5">
      </div>
      <div class="form-group">
        <label for="height"><i class="fas fa-ruler-vertical"></i> ркКркВркЪрк╛ркИ (рк╕рлЗркорлА)</label>
        <input id="height" type="number" step="0.1" required placeholder="ркЙркжрк╛рк╣рк░ркг: 65.2">
      </div>


      <button class="btn-primary" type="submit">
        <i class="fas fa-save"></i>
        ркмрк╛рк│ркХ ркЙркорлЗрк░рлЛ / ркЕрккркбрлЗркЯ ркХрк░рлЛ
      </button>
    </form>
  </div>

  <!-- Filters Card -->
  <div class="filters-card">
    <div class="filters-title">
      <i class="fas fa-filter"></i>
      рклрк┐рк▓рлНркЯрк░рлНрк╕ ркЕркирлЗ ркПркХрлНрк╕рккрлЛрк░рлНркЯ
    </div>
    <div class="filters" style="justify-content:space-between;align-items:center">
      <div style="display:flex;gap:8px;align-items:center">
        <!-- DataTables will render buttons here -->
        <div id="dtButtons"></div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <select id="ageGroupFilter" title="ркЙркВркорк░ ркЬрлВркеркерлА рклрк┐рк▓рлНркЯрк░">
          <option value="">ркмркзрк╛ ркЙркВркорк░ ркЬрлВрке</option>
          <option value="(0-6mnth)">0-6 ркорк╣рк┐ркирк╛</option>
          <option value="(6-1yr)">6-12 ркорк╣рк┐ркирк╛</option>
          <option value="(1-3 yr)">1-3 рк╡рк░рлНрк╖</option>
          <option value="(3-5 yr)">3-5 рк╡рк░рлНрк╖</option>
          <option value="(5-6 yr)">5-6 рк╡рк░рлНрк╖</option>
        </select>

        <select id="sexFilter" title="рк▓рк┐ркВркЧркерлА рклрк┐рк▓рлНркЯрк░">
          <option value="">ркмркзрк╛ (рк▓рк┐ркВркЧ)</option>
          <option value="boy">ркЫрлЛркХрк░рлЛ</option>
          <option value="girl">ркЫрлЛркХрк░рлА</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Table Card -->
  <div class="table-card">
    <div class="table-title">
      <i class="fas fa-table"></i>
      ркмрк╛рк│ркХрлЛркирлА ркорк╛рк╣рк┐ркдрлА
    </div>
    <div class="loader" id="tableLoader"></div>
    <div class="table-wrap">
      <div class="table-wrap-inner" style="margin-top:10px">
        <table id="childTable" class="display" style="width:100%">
          <thead>
            <tr>
              <th>ркХрлНрк░рко</th>
              <th>ркмрк╛рк│ркХркирлБркВ ркирк╛рко</th>
              <th>ркорк╛ркдрк╛ркирлБркВ ркирк╛рко</th>
              <th>рк▓рк┐ркВркЧ</th>
              <th>ркЬркирлНркоркдрк╛рк░рлАркЦ</th>
              <th>ркЙркВркорк░</th>
              <th>ркЙркВркорк░ркЬрлВрке</th>
              <th>ркорлЛркмрк╛ркЗрк▓</th>
              <th>ркЖркзрк╛рк░</th>
              <th>ркЕрккрк╛рк░ ID</th>
              <th>ркЖркнрк╛ ID</th>
              <th>рк╡ркЬрки/ркКркВркЪрк╛ркИ ркдрк╛рк░рлАркЦ</th> <!-- Column Moved Here -->
              <th>рк╡ркЬрки</th>
              <th>ркКркВркЪрк╛ркИ</th>
              <th>ркЧрлНрк░рлЗркб</th>
              <th>ркХрлНрк░рк┐ркпрк╛</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <footer>
    <i class="fas fa-code"></i> рк╡рк┐ркХрк╕рк┐ркд ркХрк░рлНркпрлБркВ: ркжрлЗрк╡рлЗркирлНркжрлНрк░ рк░рк╛ркорк╛ркирлБркЬ тАв 9276505035 ЁЯЩП
  </footer>
</div>

<!-- Scripts: jQuery + DataTables + Buttons + export libs -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
/* -------------------------
   Theme Toggle
   ------------------------- */
document.addEventListener('DOMContentLoaded', function() {
  // Check for saved theme preference or default to light mode
  const currentTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', currentTheme);
  
  // Update icon based on current theme
  const themeIcon = document.getElementById('themeIcon');
  if (currentTheme === 'dark') {
    themeIcon.classList.remove('fa-sun');
    themeIcon.classList.add('fa-moon');
  }
  
  // Add click event to toggle theme
  const themeToggle = document.getElementById('themeToggle');
  themeToggle.addEventListener('click', function() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    // Update theme
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    // Update icon
    if (newTheme === 'dark') {
      themeIcon.classList.remove('fa-sun');
      themeIcon.classList.add('fa-moon');
    } else {
      themeIcon.classList.remove('fa-moon');
      themeIcon.classList.add('fa-sun');
    }
  });
});

/* -------------------------
   LocalStorage helpers
   ------------------------- */
function getChildren(){ return JSON.parse(localStorage.getItem('childrenData')||'[]'); }
function setChildren(arr){ localStorage.setItem('childrenData', JSON.stringify(arr)); }

/* -------------------------
   Utils: age, group, grade
   ------------------------- */
function calculateAge(dobStr){
  if(!dobStr) return '';
  const dob = new Date(dobStr);
  const today = new Date();
  let years = today.getFullYear() - dob.getFullYear();
  let months = today.getMonth() - dob.getMonth();
  if (today.getDate() < dob.getDate()) months--;
  if (months < 0) { years--; months += 12; }
  return `${years} рк╡рк░рлНрк╖, ${months} ркорк╣рк┐ркирк╛`;
}
function calculateAgeGroup(dobStr){
  if(!dobStr) return '';
  const dob = new Date(dobStr), today = new Date();
  let totalMonths = (today.getFullYear()-dob.getFullYear())*12 + (today.getMonth()-dob.getMonth());
  if (today.getDate() < dob.getDate()) totalMonths--;
  if (totalMonths <= 6) return "(0-6mnth)";
  if (totalMonths <= 12) return "(6-1yr)";
  if (totalMonths <= 36) return "(1-3 yr)";
  if (totalMonths <= 60) return "(3-5 yr)";
  if (totalMonths <= 72) return "(5-6 yr)";
  return "";
}
function calculateGrade(weight, height){
  const h = Number(height);
  const w = Number(weight);
  if (!h || !w) return { text: '-', cls: '' };
  const bmi = w / ((h/100)*(h/100));
  if (bmi < 16) return { text: 'ркЕркдрк┐ ркЧркВркнрлАрк░', cls: 'pill bad' };
  if (bmi < 18.5) return { text: 'ркЧркВркнрлАрк░', cls: 'pill warn' };
  return { text: 'рк╕рк╛ркорк╛ркирлНркп', cls: 'pill ok' };
}

/* -------------------------
   Show success message
   ------------------------- */
function showSuccessMessage(message) {
  $('#successText').text(message);
  $('#successMessage').fadeIn().delay(2000).fadeOut();
}

/* -------------------------
   DataTable initialization
   ------------------------- */
let table;
function initDataTable(){
  // If exists, destroy
  if ($.fn.DataTable.isDataTable('#childTable')) {
    table.clear().draw();
    table.destroy();
  }

  table = $('#childTable').DataTable({
    dom: 'Brtip',          // <-- 'f' removed: NO search box
    buttons: [
      { extend: 'excelHtml5', text: '<i class="fas fa-file-excel"></i> ркПркХрлНрк╕рлЗрк▓' },
      { extend: 'pdfHtml5', text: '<i class="fas fa-file-pdf"></i> рккрлАркбрлАркПркл' },
      { extend: 'print', text: '<i class="fas fa-print"></i> ркЫрк╛рккрлЛ' },
      { extend: 'colvis', text: '<i class="fas fa-columns"></i> ркХрлЙрк▓рко' }
    ],
    columnDefs: [
      { targets: 15, orderable: false } // action column not sortable (index is 15)
    ],
    paging: true,
    pageLength: 10,
    lengthChange: false,
    info: true,
    language: { 
      emptyTable: "ркХрлЛркИ рк░рлЗркХрлЛрк░рлНркб ркорк│рлНркпрк╛ ркиркерлА",
      info: "ркХрлБрк▓ _START_ ркерлА _END_ ркирк╛ _TOTAL_ рк░рлЗркХрлЛрк░рлНркб",
      paginate: {
        first: "рккрлНрк░ркерко",
        last: "ркЕркВркдрк┐рко",
        next: "ркЖркЧрк│",
        previous: "рккрк╛ркЫрк│"
      }
    }
  });

  // Move buttons to our custom container for styling
  table.buttons().container().appendTo('#dtButtons');
}

/* -------------------------
   Render rows from storage
   ------------------------- */
function renderRows(){
  $('#tableLoader').show();
  initDataTable();
  const data = getChildren();
  data.forEach((c, idx) => {
    const grade = calculateGrade(c.weight, c.height);
    const row = [
      idx + 1,
      c.name || '',
      c.motherName || '',
      c.sex === 'boy' ? 'ркЫрлЛркХрк░рлЛ' : (c.sex === 'girl' ? 'ркЫрлЛркХрк░рлА' : ''),
      c.dob || '',
      calculateAge(c.dob),
      calculateAgeGroup(c.dob),
      c.mobileNumber || '',
      c.aadhaarNumber || '',
      c.apaarId || '',
      c.abhaId || '',
      c.measureDate || '', // <-- Data moved here
      c.weight !== undefined ? c.weight : '',
      c.height !== undefined ? c.height : '',
      `<span class="${grade.cls}">${grade.text}</span>`,
      `<button class="action-btn edit" data-id="${c.id}"><i class="fas fa-edit"></i> рк╕рлБркзрк╛рк░рлЛ</button>
       <button class="action-btn del" data-id="${c.id}"><i class="fas fa-trash"></i> ркХрк╛ркврлЛ</button>`
    ];
    table.row.add(row).draw(false);
  });
  $('#tableLoader').hide();

  // Wire edit/delete clicks (delegated)
  $('#childTable tbody').off('click').on('click', 'button.edit', function(){
    const id = Number($(this).data('id')); startEdit(id);
  });
  $('#childTable tbody').on('click', 'button.del', function(){
    const id = Number($(this).data('id')); confirmDelete(id);
  });
}

/* -------------------------
   Form handlers: add / edit
   ------------------------- */
 $('#childForm').on('submit', function(e){
  e.preventDefault();
  const editId = $('#editId').val();
  const child = {
    id: editId ? Number(editId) : Date.now(),
    name: $('#name').val().trim(),
    motherName: $('#motherName').val().trim(),
    sex: $('#sex').val(),
    dob: $('#dob').val(),
    mobileNumber: $('#mobileNumber').val().trim(),
    aadhaarNumber: $('#aadhaarNumber').val().trim(),
    apaarId: $('#apaarId').val().trim(),
    abhaId: $('#abhaId').val().trim(),
    measureDate: $('#measureDate').val(), // <-- Field value
    weight: $('#weight').val(),
    height: $('#height').val()
  };

  let arr = getChildren();
  if (editId) {
    arr = arr.map(x => x.id === child.id ? child : x);
    showSuccessMessage('ркмрк╛рк│ркХркирлА ркорк╛рк╣рк┐ркдрлА рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркЕрккркбрлЗркЯ ркХрк░рк╛ркИ!');
  } else {
    arr.push(child);
    showSuccessMessage('ркирк╡рк╛ ркмрк╛рк│ркХркирлА ркорк╛рк╣рк┐ркдрлА рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркЙркорлЗрк░рк╛ркИ!');
  }
  setChildren(arr);
  // reset & re-render
  this.reset(); $('#editId').val('');
  renderTableRefresh();
});

/* -------------------------
   Edit flow
   ------------------------- */
function startEdit(id){
  const arr = getChildren();
  const c = arr.find(x => x.id === id);
  if (!c) return;
  $('#editId').val(c.id);
  $('#name').val(c.name);
  $('#motherName').val(c.motherName);
  $('#sex').val(c.sex);
  $('#dob').val(c.dob);
  $('#mobileNumber').val(c.mobileNumber);
  $('#aadhaarNumber').val(c.aadhaarNumber);
  $('#apaarId').val(c.apaarId);
  $('#abhaId').val(c.abhaId);
  $('#measureDate').val(c.measureDate); // <-- Added for edit
  $('#weight').val(c.weight);
  $('#height').val(c.height);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* -------------------------
   Delete with confirmation
   ------------------------- */
function confirmDelete(id){
  const ok = confirm("рк╢рлБркВ ркдркорлЗ ркЖ рк░рлЗркХрлЛрк░рлНркб ркЦрк░рлЗркЦрк░ ркбрк┐рк▓рлАркЯ ркХрк░рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?");
  if (!ok) return;
  const arr = getChildren().filter(x => x.id !== id);
  setChildren(arr);
  showSuccessMessage('ркмрк╛рк│ркХркирлЛ рк░рлЗркХрлЛрк░рлНркб рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркХрк╛ркврлА ркирк╛ркЦрк╛ркпрлЛ!');
  renderTableRefresh();
}

/* -------------------------
   Filters: age & sex
   ------------------------- */
function applyFiltersToTable(){
  const ageVal = $('#ageGroupFilter').val();
  const sexVal = $('#sexFilter').val();

  table.rows().every(function(){
    const d = this.data();
    let show = true;
    if (ageVal) {
      show = (d[6] === ageVal); // ageGroup column
    }
    if (show && sexVal) {
      show = (sexVal === 'boy' ? d[3] === 'ркЫрлЛркХрк░рлЛ' : d[3] === 'ркЫрлЛркХрк░рлА');
    }
    $(this.node()).toggle(show);
  });
}
 $('#ageGroupFilter, #sexFilter').on('change', applyFiltersToTable);

/* -------------------------
   Helper to refresh table (destroy & re-render)
   ------------------------- */
function renderTableRefresh(){
  if ($.fn.DataTable.isDataTable('#childTable')) {
    table.clear().draw();
    table.destroy();
  }
  renderRows();
  applyFiltersToTable();
}

/* -------------------------
   Initial load
   ------------------------- */
 $(document).ready(function(){
  renderTableRefresh();
});
</script>
</body>
</html>

